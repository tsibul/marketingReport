{% extends 'header.html' %}
{% load static %}
{% block title %}Импорт{% endblock %}
{% block content %}
    <div class="full-content">
        <div class="container">
            <details class="imports">
                <summary class="active dict-block__header">Операции импорта клиентов</summary>
                <div class="imports__block">
                    <div class="form-row__import">
                        <h4 class="active border-title">1. Загрузить клиентов во временную базу </h4>
                        <div class="import-block__description">загрузить файл с csv</div>
                        <div>импортировано {{ cst_date|date:'d.m.Y' }}</div>
                        <div>записей в базе {{ customers_imported }}</div>
                        <div id="result" class="import-block__description alert"></div>
                        <button type="submit" class="btn btn-save" onclick="importFileModal(this, 'customers');">
                            импорт
                        </button>
                    </div>
                    <div class="form-row__import">
                        <h4 class="active border-title">2. Обработка временной базы</h4>
                        <div class="import-block__description form-row__double">Поиск новых, измененных и внутренних
                            клиентов
                        </div>
                        <div id="new-customers" class="alert"></div>
                        <div id="updated-customers" class="alert"></div>
                        <button type="button" class="btn btn-save" onclick="editTemporaryBase();">обработать</button>
                    </div>
                    <div class="form-row__import">
                        <h4 class="active border-title">3.1 Импорт новых клиентов в БД</h4>
                        <div class="import-block__description form-row__double">импорт новых клиентов в основную базу
                        </div>
                        <div>новые клиенты {{ customers_new }}</div>
                        <div id="import_new_customers"></div>
                        <button type="button" class="btn btn-save" onclick="importCustomers('import_new_customers');">
                            импорт
                        </button>
                    </div>
                    <div class="form-row__import">
                        <h4 class="active border-title">3.2 Импорт измененных клиентов в БД</h4>
                        <div class="import-block__description form-row__double">импорт измененных клиентов в основную
                            базу (опционально)
                        </div>
                        <div>измененные клиенты {{ customers_changed }}</div>
                        <div id="import_changed_customers"></div>
                        <button type="button" class="btn btn-save"
                                onclick="importCustomers('import_changed_customers')">импорт
                        </button>
                    </div>
                </div>
            </details>
            <details class="imports">
                <summary class="active dict-block__header">Операции импорта продаж</summary>
                <div class="imports__block">
                    <div class="form-row__import">
                        <h4 class="active border-title">1. Загрузить отгрузки во временный файл</h4>
                        <div class="import-block__description">загрузить файл с csv</div>
                        <div>импортировано {{ sales_date|date:'d.m.Y' }}</div>
                        <div>записей в базе {{ sales_imported }}</div>
                        <div id="result" class="import-block__description alert"></div>
                        <button type="submit" class="btn btn-save" onclick="importFileModal(this, 'sales');">
                            импорт
                        </button>
                    </div>

                </div>
            </details>
            <details class="imports">
                <summary class="active dict-block__header">Периоды расчета</summary>
                <div class="imports__block">
                    <form class="form-row__import" method="post" action="{% url 'marketing_report:reassign_periods' %}">
                    {% csrf_token %}
                        <h4 class="active border-title">1. Пересоздать периоды расчета</h4>
                        <label for="period-begin">начало периода (<span class="alert">{{ period_begin|date:'d.m.Y' }}</span>)</label>
                        <input type="date" id="period-begin" class="form-input" name="start_date" required>
                        <label for="period-end">конец периода (<span class="alert">{{ period_end|date:'d.m.Y' }}</span>)</label>
                        <input type="date" id="period-end" class="form-input" name="end_date" required>
                        <button type="submit" class="btn btn-save" onclick="reassignPeriods(this);">
                            пересоздать
                        </button>
                    </form>

                </div>
            </details>
        </div>
    </div>
    <!--- Import file modal -->
    <div class="import-file-modal" id="import-file-modal">
        <form class="import-file-modal__body" method="post" enctype="multipart/form-data"
              action="{% url 'marketing_report:import_file' %}">
            {% csrf_token %}
            <input type="text" name="file_name" id="file-name" hidden>
            <div class="border-title active import-file-modal__header">Импорт из .csv</div>
            <div class="import-file-modal__content">
                <input type="file" accept=".csv" required class="import-file-modal__input" name="loaded_file">
            </div>
            <div class="import-file-modal__buttons">
                <button type="button" class="btn btn-close modal-close" onclick="importFileModalClose(this);">закрыть</button>
                <button type="submit" class="btn btn-save" onclick="importFileModal(this, 'sales')">загрузить</button>
            </div>
        </form>
    </div>

    <div hidden id="technical-data">
        <div id="periods">{{ json_period }}</div>
    </div>
    <script src="{% static 'marketing_report/js/imports.js' %}"></script>
{% endblock %}
